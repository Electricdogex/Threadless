<!doctype html>
<html lang="en" data-theme="forest">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Threadless Â· ALPHA</title>

<!-- Security: CSP + robots -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'none';
  form-action 'self';
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' https://cdn.jsdelivr.net https://cdn.skypack.dev 'unsafe-inline';
  connect-src 'self' https://*.supabase.co wss://*.supabase.co;
  upgrade-insecure-requests;">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="robots" content="noindex, nofollow">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230e1613'/%3E%3Cpath d='M16 20h32M16 32h32M16 44h32' stroke='%23ff8b3d' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E">

<style>
  /* === Theme tokens === */
  /* === Theme tokens === */
:root{
  --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27;
  --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f; --bad:#ff8c8c;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; /* NEW */
}
  [data-theme="forest"]{ --bg:#0e1613; --card:#122019; --ink:#e9f5ee; --muted:#9db7ab; --line:#1e2e27; --accent:#ff8b3d; --accent-2:#1f9d68; --accent-2-ink:#06120d; --warn:#ffd08f }
  [data-theme="sunset"]{ --bg:#160f12; --card:#22161b; --ink:#ffeef3; --muted:#c5a7b3; --line:#2d1e25; --accent:#ff6b6b; --accent-2:#ffb86b; --accent-2-ink:#2b130f; --warn:#ffe0b5 }
  [data-theme="midnight"]{ --bg:#0d0f19; --card:#121427; --ink:#e9ebff; --muted:#a9b0d4; --line:#1a1d36; --accent:#8ab4ff; --accent-2:#6ae6c1; --accent-2-ink:#021410; --warn:#ffd9a3 }
  [data-theme="ocean"]{ --bg:#07171d; --card:#0d2330; --ink:#e6fbff; --muted:#a6c9d6; --line:#143244; --accent:#26b0ff; --accent-2:#15d1b2; --accent-2-ink:#01221c; --warn:#ffe6b8 }
  [data-theme="grape"]{ --bg:#160d1a; --card:#231128; --ink:#f6e9ff; --muted:#c7abd8; --line:#31153b; --accent:#c47dff; --accent-2:#ff9fb3; --accent-2-ink:#2b0c18; --warn:#ffe0c1 }
  [data-theme="mono"]{ --bg:#0c0c0c; --card:#141414; --ink:#f5f5f5; --muted:#bcbcbc; --line:#202020; --accent:#ffffff; --accent-2:#d0d0d0; --accent-2-ink:#121212; --warn:#ffd08f }

  /* === NEW: X (formerly Twitter) theme === */
  [data-theme="x"]{
    --bg:#000000;
    --card:#0a0a0a;
    --ink:#e7e9ea;
    --muted:#71767b;
    --line:#2f3336;
    --accent:#1d9bf0;
    --accent-2:#1d9bf0;
    --accent-2-ink:#00131f;
    --warn:#ffd9a3;
    --btn-ink:#ffffff; /* white text on blue buttons */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 20% -10%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 60%),
      radial-gradient(1000px 800px at 120% -20%, color-mix(in srgb, var(--card) 60%, transparent) 0%, transparent 55%),
      var(--bg);
    color:var(--ink);
    font:16px/1.5 var(--font); /* CHANGED to use token */
  }

  /* Flatten background for X */
  [data-theme="x"] body{ background: var(--bg) !important; }

  header{ position:sticky; top:0; z-index:3; background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent); backdrop-filter: blur(6px); border-bottom:1px solid var(--line) }
  /* Subtler header glass on X */
  [data-theme="x"] header{
    background:linear-gradient(180deg, color-mix(in srgb, #000 65%, transparent), transparent);
    backdrop-filter: blur(4px);
    border-bottom:1px solid var(--line);
  }

  .wrap{max-width:860px;margin:0 auto;padding:16px}
  h1{margin:0 0 4px; font-size:22px; letter-spacing:.2px}
  .sub{color:var(--muted);font-size:13px}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{ width:32px;height:32px;border-radius:10px;background:var(--bg);border:1px solid var(--line); display:grid; place-items:center }
  .logo::after{ content:''; display:block; width:24px; height:6px; border-radius:6px; background:var(--accent); box-shadow:0 12px 0 var(--accent), 0 24px 0 var(--accent); transform:translateY(-6px) }
  /* X-style logo */
  [data-theme="x"] .logo{ background:#000; border-color:var(--line); }
  [data-theme="x"] .logo::after{
    content:'X';
    width:auto; height:auto;
    background:none; box-shadow:none; transform:none;
    color:#fff; font:800 16px/1 var(--font); letter-spacing:.5px;
  }

  .alpha{ font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--accent-2-ink); background:linear-gradient(180deg, var(--accent-2), color-mix(in srgb, var(--accent-2) 75%, #000 0%)); border:1px solid color-mix(in srgb, var(--accent-2) 65%, black); border-radius:999px; padding:6px 10px; box-shadow:0 4px 14px color-mix(in srgb, var(--accent-2) 25%, transparent), inset 0 1px 0 rgba(255,255,255,.08) }
  .pill{font-size:12px;color:var(--muted)}

  .theme-switch{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px }
  .theme-select{ appearance:none; border:1px solid var(--line); background:var(--card); color:var(--ink); border-radius:10px; padding:6px 10px; cursor:pointer }

  .switch{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px}
  .switch input{ width:16px; height:16px; cursor:pointer }

  .composer{ margin:16px 0; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
  /* Flatter cards on X */
  [data-theme="x"] .composer,
  [data-theme="x"] .post,
  [data-theme="x"] .reply{
    background:var(--card);
    border-color:var(--line);
    box-shadow:none;
  }

  textarea{ width:100%; min-height:110px; background:color-mix(in srgb, var(--bg) 90%, black 10%); color:var(--ink); border:1px solid color-mix(in srgb, var(--line) 75%, black 25%); border-radius:12px; padding:12px; resize:vertical; outline:none }
  textarea:focus{ border-color:color-mix(in srgb, var(--accent-2) 60%, #000 40%); box-shadow:0 0 0 4px color-mix(in srgb, var(--accent-2) 20%, transparent) }
  /* Blue focus accent on X */
  [data-theme="x"] textarea:focus{
    border-color: color-mix(in srgb, var(--accent) 70%, #000 30%);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent);
  }

  .row{display:flex; gap:12px; align-items:center; margin-top:10px}
  .btn{ border:0; border-radius:12px; padding:10px 14px; background:linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 75%, #000 25%)); color:var(--btn-ink, #28150a); font-weight:800; cursor:pointer; box-shadow: 0 6px 18px color-mix(in srgb, var(--accent) 25%, transparent), inset 0 1px 0 rgba(255,255,255,.15) }
  .btn[disabled]{opacity:.55; cursor:not-allowed}
  /* Primary button look on X */
  [data-theme="x"] .btn{
    background: linear-gradient(180deg, var(--accent), color-mix(in srgb, var(--accent) 75%, #000 25%));
    color: var(--btn-ink, #fff);
  }

  .meta{margin-left:auto; color:var(--muted); font-size:12px}

  .feed{display:flex; flex-direction:column; gap:12px; margin:20px 0}
  .post{padding:14px 14px 10px; background:linear-gradient(180deg, color-mix(in srgb, var(--accent) 12%, transparent), transparent 35%), var(--card); border:1px solid var(--line); border-radius:16px}
  .headerline{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px; margin-bottom:6px}
  .flair{font-weight:700; color:var(--ink)}
  .content{white-space:pre-wrap; word-wrap:break-word}
  .time{margin-top:8px; color:var(--muted); font-size:12px}

  .actions{display:flex; align-items:center; gap:10px; margin-top:10px; user-select:none; color:var(--muted); font-size:13px}
  .emoji{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:color-mix(in srgb, var(--bg) 92%, black 8%); cursor:pointer}
  /* Inputs/chips darker on X */
  [data-theme="x"] .emoji,
  [data-theme="x"] .pager .load-more,
  [data-theme="x"] textarea{
    background:#000;
    border-color:var(--line);
  }

  .emoji[disabled]{opacity:.5; cursor:not-allowed}
  .count{color:var(--ink)}
  .report{margin-left:auto; cursor:pointer; color:var(--muted); border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:transparent}
  .report:hover{color:var(--ink); border-color:var(--accent)}
  /* Report/pills on X */
  [data-theme="x"] .report{ background:#000; border-color:var(--line); color:var(--muted); }
  [data-theme="x"] .report:hover{ color:var(--ink); border-color:var(--accent); }

  .notice{margin-top:8px; color:var(--warn); font-size:12px}
  a{color:var(--accent); text-decoration:none}

  .btn.mini{ padding:6px 10px; font-weight:700; margin-left:8px }

  .replies{ margin-top:10px; border-top:1px dashed var(--line); padding-top:8px; display:flex; flex-direction:column; gap:8px }
  .reply{ background:color-mix(in srgb, var(--card) 85%, black 15%); border:1px solid var(--line); border-radius:12px; padding:10px }
  .reply .rhead{ display:flex; gap:8px; color:var(--muted); font-size:12px; margin-bottom:4px }
  .reply .rflair{ font-weight:700; color:var(--ink) }
  .reply .rcontent{ white-space:pre-wrap }

  .replybox{ display:flex; gap:8px; margin-top:8px }
  .replybox textarea{ min-height:60px }
  .replybox .rbtn{ white-space:nowrap }

  .pager{display:flex; justify-content:center; margin:16px 0 32px}
  .pager .load-more{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:999px; padding:10px 16px; background:color-mix(in srgb, var(--bg) 90%, black 10%); color:var(--ink); cursor:pointer}
  .pager .load-more[disabled]{opacity:.6; cursor:not-allowed}
  .spinner{width:14px; height:14px; border:2px solid color-mix(in srgb, var(--accent-2) 60%, transparent); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  footer{color:var(--muted); font-size:12px; margin:36px 0; text-align:center}
  footer .copyright{margin-top:8px; color:var(--muted); font-size:11px}

  .toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:var(--card); border:1px solid var(--line); color:var(--ink); padding:10px 14px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25); font-size:13px; display:none}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Threadless</h1>
            <div class="sub">A single, continuous anonymous board Â· <strong>ALPHA PROTOTYPE</strong></div>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="alpha">Alpha Prototype</span>

          <div class="theme-switch">
            Theme:
            <select id="theme" class="theme-select" aria-label="Select theme">
              <option value="forest">Forest</option>
              <option value="sunset">Sunset</option>
              <option value="midnight">Midnight</option>
              <option value="ocean">Ocean</option>
              <option value="grape">Grape</option>
              <option value="mono">Mono</option>
              <option value="x">X</option><!-- NEW -->
            </select>
          </div>

          <!-- Mature content toggle -->
          <label class="switch" title="Show posts & replies that include slurs/explicit/violent/extremist terms">
            <input type="checkbox" id="matureToggle" />
            Show mature
          </label>

          <span class="pill" id="status">connectingâ¦</span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="composer" aria-label="Create a post">
      <textarea id="text" maxlength="1000" placeholder="Share a thoughtâ¦ (Enter to post, Shift+Enter = newline)"></textarea>
      <div class="row">
        <button class="btn" id="postBtn" aria-label="Post message">Post</button>
        <div class="meta">
          <span id="count">0</span>/1000 â¢ cooldown: <span id="cool">0</span>s â¢ you are
          <span id="meFlair"></span>
          <button class="btn mini" id="rerollBtn" type="button" title="Get a new anonymous flair">Reroll</button>
        </div>
      </div>
      <div class="notice">
        Be civil. Donât post illegal, harmful, or personal data. Everything here is public and may be removed.
        This is an <strong>alpha</strong>âcontent may be lost.
      </div>
    </section>

    <section class="feed" id="feed" aria-live="polite"></section>

    <div class="pager">
      <button class="load-more" id="loadMoreBtn">
        <span class="spinner" id="moreSpin" style="display:none"></span>
        <span id="moreLabel">Load more</span>
      </button>
    </div>

    <footer>
      <div>Tip: open in two tabs to see realtime updates. Posts are immutable in this MVP.</div>
      <div class="copyright">Â© 2022â2025 Chrome Gear Software</div>
    </footer>
  </main>

  <div class="toast" id="toast"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>

  <!-- === MODULES (split by clear sections; safe to edit individually) === -->
  <script>
  'use strict';

  /* ============================================================
   * [MODULE A] CONFIG / STATE
   * ============================================================ */
  const TL = window.TL = {
    VERSION: 'alpha-modular-1.0.0',

    // Supabase
    SUPABASE_URL: "https://hqwerxoapoczigetylfj.supabase.co",
    SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhxd2VyeG9hcG9jemlnZXR5bGZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNTIyNTQsImV4cCI6MjA3MTgyODI1NH0.-MGwuD5NzuHo23GrYD-GsSdeGKoVh_ggDGqp0v7eXoo",
    sb: null,

    // Feature flags
    COOLDOWN_SEC: 15,
    PAGE_SIZE: 30,
    SOURCE: 'posts_public',     // fallback to 'posts' if not present
    HAS_FLAIR: true,
    HAS_MATURE_POSTS: true,
    HAS_MATURE_REPLIES: true,
    REACTIONS_AVAILABLE: true,

    // UI refs (wired in boot)
    els: {},

    // Pagination
    nextCursor: null,           // { created_at, id }
    seen: new Set(),
    POST_MATURE: new Map(),     // parent-post maturity lookup

    // User prefs
    SHOW_MATURE: (localStorage.getItem('threadless_show_mature') === '1'),

    // Hooks for you:
    setShowMature(v){
      TL.SHOW_MATURE = !!v;
      try { localStorage.setItem('threadless_show_mature', v ? '1':'0'); } catch {}
      TL.actions.reloadFeed();
    },
    updateBadWords(extra){ TL.safety.mergeBadWords(extra); },
    refresh(){ TL.actions.reloadFeed(); },
  };
  </script>

  <script>
  /* ============================================================
   * [MODULE B] DOM / UTILS
   * ============================================================ */
  TL.util = (function(){
    const $ = id => document.getElementById(id);
    const els = {
      status: $('status'),
      text: $('text'),
      postBtn: $('postBtn'),
      feed: $('feed'),
      count: $('count'),
      cool: $('cool'),
      loadMoreBtn: $('loadMoreBtn'),
      moreSpin: $('moreSpin'),
      moreLabel: $('moreLabel'),
      theme: $('theme'),
      meFlair: $('meFlair'),
      toast: $('toast'),
      matureToggle: $('matureToggle'),
      rerollBtn: $('rerollBtn')
    };
    TL.els = els;

    const ZERO_WIDTH = /[\u200B-\u200D\uFEFF]/g;
    const DEOB = {'1':'i','!':'i','|':'i','@':'a','4':'a','$':'s','3':'e','0':'o','7':'t','5':'s','8':'b'};

    function deobfuscate(s){ return s.replace(/[1!|@4$30 75 8]/g, ch => DEOB[ch] ?? ch); }
    function canonical(s){
      return deobfuscate((s||'').normalize('NFKC').replace(ZERO_WIDTH,'')).toLowerCase().trim();
    }

    const SEP = /[^a-z0-9]+/g;
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const nowSec = ()=>Math.floor(Date.now()/1000);
    function getCooldownLeft(){
      const last = Number(localStorage.getItem('lastPostTs')||'0');
      return Math.max(0,(last+TL.COOLDOWN_SEC)-nowSec());
    }
    function setJustPosted(){ localStorage.setItem('lastPostTs', String(nowSec())); }
    function sanitize(s){ return (s||'').trim(); }
    function toast(msg){ els.toast.textContent = msg; els.toast.style.display='block'; setTimeout(()=>els.toast.style.display='none', 1600); }
    function showStatus(msg){ els.status.textContent = msg; }

    // Theme
    const savedTheme = localStorage.getItem('threadless_theme') || 'forest';
    document.documentElement.setAttribute('data-theme', savedTheme);

    return {
      $, els, canonical, SEP, sleep, nowSec, getCooldownLeft, setJustPosted, sanitize, toast, showStatus
    };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE C] SAFETY (regex + fuzzy)
   *  - Tuning knobs at the top
   * ============================================================ */
  TL.safety = (function(){
    const { canonical, SEP } = TL.util;

    // === Tuning (safe defaults, expanded) ===
const FUZZY_CORE = [
  // profanity / harassment (stems)
  'fuck','shit','ass','asshole','bastard','motherfucker','bullshit',
  'bitch','prick','twat','wanker','bollocks','bugger','goddamn','damn',
  'dick','cock','pussy','cunt','tits','boobs','balls','scrote','schlong',

  // sexual / porn (stems)
  'porn','porno','pr0n','nsfw','xxx','hentai','futanari','onlyfans',
  'camgirl','camwhore','bdsm','deepthroat','rimjob','blowjob','handjob',
  'cum','cumshot','creampie','facial','milf','gilf','thot','skank','slut',
  'anal','rimming','pegging','fisting','gangbang','bukkake','tittyfuck',

  // harm / abuse
  'rape','rapist','molest','groomer','grooming','bestial','zoophil','incest',
  'necrophil','ped','pedo','paedo','cp', // (child-abuse shorthand)

  // self-harm / threats / violence / gore
  'kys','suicide','selfharm','dox','swat','lynch','beheading','dismember',
  'disembowel','snuff','gore',

  // extremist (stems)
  'nazi','heil','swastika','thirdreich','whitepower','whitepride','1488','wpww',
];

// keep these guards to avoid âassâ â âassumeâ type false positives
const TOKEN_MAX_EDIT = 1;   // allow 1 edit distance per token
const JOINED_MIN_LEN = 4;   // only slide windows for bases â¥4 chars
const JOINED_MAX_EDIT = 1;  // 1 edit distance for sliding checks

// === Fallback bad list (curated & expanded) ===
// NOTE: phrases are fine here; keep the DB (bad_words) as the true source of truth.
let BAD_WORDS = [
  // â Slurs (selection; keep this list maintainable, DB can be larger)
  {word:'nigger', category:'slur'},
  {word:'nigga', category:'slur'},
  {word:'coon', category:'slur'},
  {word:'porch monkey', category:'slur'},
  {word:'jigaboo', category:'slur'},
  {word:'tar baby', category:'slur'},
  {word:'chink', category:'slur'},
  {word:'gook', category:'slur'},
  {word:'zipperhead', category:'slur'},
  {word:'slant', category:'slur'},
  {word:'ching chong', category:'slur'},
  {word:'spic', category:'slur'},
  {word:'beaner', category:'slur'},
  {word:'wetback', category:'slur'},
  {word:'kike', category:'slur'},
  {word:'yid', category:'slur'},
  {word:'paki', category:'slur'},
  {word:'raghead', category:'slur'},
  {word:'sand nigger', category:'slur'},
  {word:'gypsy', category:'slur'},
  {word:'pikey', category:'slur'},
  {word:'abo', category:'slur'},
  {word:'boong', category:'slur'},
  {word:'cracker', category:'slur'},
  {word:'honky', category:'slur'},
  {word:'white trash', category:'slur'},
  {word:'faggot', category:'slur'},
  {word:'fag', category:'slur'},
  {word:'dyke', category:'slur'},
  {word:'shemale', category:'slur'},
  {word:'tranny', category:'slur'},
  {word:'homo', category:'slur'},
  {word:'butt pirate', category:'slur'},
  {word:'retard', category:'slur'},
  {word:'spaz', category:'slur'},
  {word:'mongoloid', category:'slur'},
  {word:'cripple', category:'slur'},
  {word:'downie', category:'slur'},
  {word:'autist', category:'slur'},

  // â Extremism
  {word:'nazi', category:'extremist'},
  {word:'neo-nazi', category:'extremist'},
  {word:'heil hitler', category:'extremist'},
  {word:'sieg heil', category:'extremist'},
  {word:'third reich', category:'extremist'},
  {word:'swastika', category:'extremist'},
  {word:'kkk', category:'extremist'},
  {word:'white power', category:'extremist'},
  {word:'white pride', category:'extremist'},
  {word:'1488', category:'extremist'},
  {word:'14 words', category:'extremist'},
  {word:'wpww', category:'extremist'},
  {word:'blood and soil', category:'extremist'},
  {word:'great replacement', category:'extremist'},
  {word:'holohoax', category:'extremist'},
  {word:'holocaust denial', category:'extremist'},
  {word:'atomwaffen', category:'extremist'},

  // â Threats / violence / self-harm
  {word:'kill yourself', category:'self-harm'},
  {word:'kys', category:'self-harm'},
  {word:'hang yourself', category:'self-harm'},
  {word:'self-harm', category:'self-harm'},
  {word:'suicide', category:'self-harm'},
  {word:'cut myself', category:'self-harm'},
  {word:'overdose', category:'self-harm'},
  {word:'lynch', category:'violence'},
  {word:'gas chamber', category:'violence'},
  {word:'beheading', category:'nsfl'},
  {word:'dismember', category:'nsfl'},
  {word:'disembowel', category:'nsfl'},
  {word:'snuff', category:'nsfl'},
  {word:'gore', category:'nsfl'},

  // â Sexual harm / illegal
  {word:'rape', category:'harm'},
  {word:'rapist', category:'harm'},
  {word:'molest', category:'harm'},
  {word:'groomer', category:'harm'},
  {word:'grooming', category:'harm'},
  {word:'pedophile', category:'harm'},
  {word:'paedophile', category:'harm'},
  {word:'pedo', category:'harm'},
  {word:'cp', category:'harm'},          // shorthand people type
  {word:'loli', category:'sexual'},      // used for sexualized minors content
  {word:'lolita', category:'sexual'},
  {word:'incest', category:'sexual'},
  {word:'bestiality', category:'sexual'},
  {word:'zoophilia', category:'sexual'},
  {word:'necrophilia', category:'sexual'},

  // â Porn / explicit (incl. sites & slang)
  {word:'porn', category:'sexual'},
  {word:'porno', category:'sexual'},
  {word:'pr0n', category:'sexual'},
  {word:'nsfw', category:'sexual'},
  {word:'xxx', category:'sexual'},
  {word:'hentai', category:'sexual'},
  {word:'futanari', category:'sexual'},
  {word:'onlyfans', category:'sexual'},
  {word:'camgirl', category:'sexual'},
  {word:'camwhore', category:'sexual'},
  {word:'pornhub', category:'sexual'},
  {word:'xvideos', category:'sexual'},
  {word:'xhamster', category:'sexual'},
  {word:'redtube', category:'sexual'},
  {word:'xnxx', category:'sexual'},
  {word:'rule34', category:'sexual'},

  // â Explicit/sexual terms
  {word:'cum', category:'sexual'},
  {word:'cumshot', category:'sexual'},
  {word:'creampie', category:'sexual'},
  {word:'jizz', category:'sexual'},
  {word:'jism', category:'sexual'},
  {word:'semen', category:'sexual'},
  {word:'cock', category:'sexual'},
  {word:'dick', category:'sexual'},
  {word:'penis', category:'sexual'},
  {word:'pussy', category:'sexual'},
  {word:'vagina', category:'sexual'},
  {word:'tits', category:'sexual'},
  {word:'boobs', category:'sexual'},
  {word:'nipple', category:'sexual'},
  {word:'ass', category:'profanity'},
  {word:'asshole', category:'profanity'},
  {word:'anal', category:'sexual'},
  {word:'rimjob', category:'sexual'},
  {word:'blowjob', category:'sexual'},
  {word:'handjob', category:'sexual'},
  {word:'deepthroat', category:'sexual'},
  {word:'facial', category:'sexual'},
  {word:'milf', category:'sexual'},
  {word:'gilf', category:'sexual'},
  {word:'bdsm', category:'sexual'},
  {word:'gangbang', category:'sexual'},
  {word:'bukkake', category:'sexual'},
  {word:'tittyfuck', category:'sexual'},
  {word:'pegging', category:'sexual'},
  {word:'fisting', category:'sexual'},
  {word:'buttplug', category:'sexual'},
  {word:'butt plug', category:'sexual'},

  // â Harassment / profanity (extras)
  {word:'bitch', category:'harassment'},
  {word:'whore', category:'sexual'},
  {word:'slut', category:'sexual'},
  {word:'thot', category:'sexual'},
  {word:'skank', category:'sexual'},
  {word:'prick', category:'harassment'},
  {word:'twat', category:'harassment'},
  {word:'douchebag', category:'harassment'},
  {word:'douche', category:'harassment'},
  {word:'nonce', category:'harassment'},

  // â Plain profanity
  {word:'fuck', category:'profanity'},
  {word:'fucking', category:'profanity'},
  {word:'motherfucker', category:'profanity'},
  {word:'mf', category:'profanity'},
  {word:'shit', category:'profanity'},
  {word:'bullshit', category:'profanity'},
  {word:'bastard', category:'profanity'},
  {word:'goddamn', category:'profanity'},
  {word:'damn', category:'profanity'},
  {word:'piss', category:'profanity'},
  {word:'wanker', category:'profanity'},
  {word:'bollocks', category:'profanity'},
  {word:'bugger', category:'profanity'},
];
    let BAD_RE = null;

    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function rebuildBadRegex(){
      const words = [...new Set((BAD_WORDS||[]).map(x => (x.word||'').trim()).filter(Boolean))]
        .map(escapeRegExp).sort((a,b)=>b.length-a.length);
      BAD_RE = words.length ? new RegExp("\\b(?:"+words.join("|")+")\\b","i") : null;
    }

    // Fuzzy helpers
    function collapseRepeats(s){ return s.replace(/([a-z0-9])\1{2,}/g, '$1$1'); }
    function tokensForFuzzy(s){
      const base = collapseRepeats(canonical(s));
      const tokens = base.replace(SEP, ' ').trim().split(/\s+/).filter(Boolean);
      const joined = base.replace(SEP, '');
      return { tokens, joined, base };
    }
    function lev(a,b){
      const m=a.length, n=b.length;
      if (!m) return n; if (!n) return m;
      const dp = Array(n+1); for (let j=0;j<=n;j++) dp[j]=j;
      for (let i=1;i<=m;i++){
        let prev = dp[0], tmp; dp[0]=i;
        for (let j=1;j<=n;j++){
          tmp = dp[j];
          dp[j] = (a[i-1]===b[j-1]) ? prev : 1 + Math.min(prev, dp[j], dp[j-1]);
          prev = tmp;
        }
      }
      return dp[n];
    }

    function fuzzyBad(text){
      const { tokens, joined } = tokensForFuzzy(text);
      if (!tokens.length && !joined) return false;

      // token-level edits
      for (const base of FUZZY_CORE){
        const bl = base.length;
        for (const t of tokens){
          if (Math.abs(t.length - bl) > 2) continue;
          if (lev(t, base) <= TOKEN_MAX_EDIT) return true;
        }
      }

      // joined sliding window, avoid short roots
      if (joined){
        const joinedLite = joined
          .replace(/\*/g,'')
          .replace(/ph/g,'f')
          .replace(/q/g,'k')
          .replace(/ck/g,'k')
          .replace(/x/g,'ks');

        const scanIn = (hay) => {
          for (const base of FUZZY_CORE){
            if (base.length < JOINED_MIN_LEN) continue;
            const bl = base.length;
            const minL = Math.max(JOINED_MIN_LEN, bl-1), maxL = Math.min(bl+2, hay.length);
            for (let L=minL; L<=maxL; L++){
              for (let i=0; i+L<=hay.length; i++){
                if (lev(hay.slice(i,i+L), base) <= JOINED_MAX_EDIT) return true;
              }
            }
          }
          return false;
        };

        if (scanIn(joined)) return true;
        if (scanIn(joinedLite)) return true;
      }
      return false;
    }

    // Public API
    async function loadFromDB(){
      const { data, error } = await TL.sb.from('bad_words').select('word, category');
      if (!error && data){
        const seen = new Set();
        BAD_WORDS = [...data, ...BAD_WORDS].filter(({word})=>{
          const w = (word||'').toLowerCase();
          if (seen.has(w)) return false; seen.add(w); return true;
        });
      }
      rebuildBadRegex();
    }
    function mergeBadWords(extra){
      if (!Array.isArray(extra)) return;
      BAD_WORDS.push(...extra);
      rebuildBadRegex();
    }
    function matchesBadWord(t){ return (BAD_RE && BAD_RE.test(canonical(t))) || fuzzyBad(t); }
    const needsNudge = (text)=>matchesBadWord(text);
    const isMatureText = (text)=>matchesBadWord(text);

    return { loadFromDB, mergeBadWords, matchesBadWord, needsNudge, isMatureText };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE D] SESSION / THEME / TAG
   * ============================================================ */
  TL.session = (function(){
    const { els } = TL.util;
    function makeTag(){
      const adjectives = ['Fern','Drift','Quiet','Copper','Ivory','Moss','Amber','Silent','Swift','Velvet','Solar','Arctic','Cinder','Echo','Prairie','Crimson','Sable','Verdant','Golden','Nimbus','Boreal','Saffron','Umber'];
      const animals    = ['Fox','Lynx','Whale','Otter','Hawk','Badger','Moth','Panda','Crane','Fennec','Stag','Koi','Raven','Viper','Wren','Wolf','Heron','Bison','Ocelot','Orca','Tern','Ibex','Dingo'];
      const a = adjectives[Math.floor(Math.random()*adjectives.length)];
      const b = animals[Math.floor(Math.random()*animals.length)];
      const num = Math.floor(Math.random()*89)+11;
      return `${a}-${b}Â·${num}`;
    }
    let SESSION_TAG = makeTag();
    els.meFlair.textContent = SESSION_TAG;
    try { sessionStorage.setItem('threadless_session_tag', SESSION_TAG); } catch {}

    function rerollTag(){
      SESSION_TAG = makeTag();
      els.meFlair.textContent = SESSION_TAG;
      try { sessionStorage.setItem('threadless_session_tag', SESSION_TAG); } catch {}
      TL.util.toast('New anon flair!');
    }

    const savedTheme = localStorage.getItem('threadless_theme') || 'forest';
    TL.util.$('theme').value = savedTheme;
    TL.util.$('theme').addEventListener('change', ()=>{
      document.documentElement.setAttribute('data-theme', TL.util.$('theme').value);
      localStorage.setItem('threadless_theme', TL.util.$('theme').value);
    });

    return { get tag(){ return SESSION_TAG; }, rerollTag };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE E] VISIBILITY LOGIC
   * ============================================================ */
  TL.visibility = (function(){
    const { isMatureText } = TL.safety;

    function rowIsMaturePost(row){
      if (TL.HAS_MATURE_POSTS && typeof row.mature === 'boolean') return row.mature === true;
      return isMatureText(row.content || '');
    }
    function rowIsMatureReply(row){
      if (TL.HAS_MATURE_REPLIES && typeof row.mature === 'boolean') return row.mature === true;
      return isMatureText(row.content || '');
    }
    function shouldRenderPost(row){ return TL.SHOW_MATURE || !rowIsMaturePost(row); }
    function parentIsMature(post_id){ return !!TL.POST_MATURE.get(post_id); }
    function shouldRenderReply(row){
      if (TL.SHOW_MATURE) return true;
      if (parentIsMature(row.post_id)) return false; // hide replies under a mature post
      return !rowIsMatureReply(row);                 // allow only clean replies under clean post
    }

    return { rowIsMaturePost, rowIsMatureReply, shouldRenderPost, shouldRenderReply, parentIsMature };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE F] RENDERING
   * ============================================================ */
  TL.render = (function(){
    const { els } = TL.util;
    const { shouldRenderPost, rowIsMaturePost, rowIsMatureReply, shouldRenderReply, parentIsMature } = TL.visibility;

    function emojiRow(post){
      const wrap = document.createElement('div');
      wrap.className = 'actions';
      if (!TL.REACTIONS_AVAILABLE) { wrap.style.display = 'none'; return wrap; }
      const emojis = [
        {key:'up',    label:'ð¼'},
        {key:'down',  label:'ð½'},
        {key:'like',  label:'ð'},
        {key:'lol',   label:'ð'},
        {key:'heart', label:'â¤ï¸'},
      ];
      emojis.forEach(({key,label})=>{
        const btn = document.createElement('button');
        btn.className = 'emoji';
        btn.dataset.key = key;
        btn.innerHTML = `<span>${label}</span> <span class="count" id="c_${post.id}_${key}">0</span>`;
        btn.addEventListener('click', ()=>TL.data.react(post.id, key, btn));
        wrap.appendChild(btn);
      });
      const reportBtn = document.createElement('button');
      reportBtn.className = 'report';
      reportBtn.textContent = 'Report';
      reportBtn.title = 'Report this post';
      reportBtn.addEventListener('click', ()=>TL.data.report(post.id));
      wrap.appendChild(reportBtn);
      return wrap;
    }

    function repliesSection(post){
      const box = document.createElement('div');
      box.className = 'replies';
      box.id = `replies_${post.id}`;

      const rbox = document.createElement('div');
      rbox.className = 'replybox';
      const ta = document.createElement('textarea');
      ta.placeholder = 'Write a replyâ¦ (Enter to send, Shift+Enter for newline)';
      ta.maxLength = 1000;
      const btn = document.createElement('button');
      btn.className = 'btn rbtn';
      btn.textContent = 'Reply';
      btn.addEventListener('click', ()=>TL.actions.sendReply(post.id, ta));
      ta.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btn.click(); }
      });
      rbox.append(ta, btn);

      box.append(rbox);
      return box;
    }

    function renderReply(row){
      const el = document.createElement('div');
      el.className = 'reply';
      el.dataset.id = row.id;
      const head = document.createElement('div');
      head.className = 'rhead';
      const f = document.createElement('span'); f.className = 'rflair'; f.textContent = (TL.HAS_FLAIR && row.flair) ? row.flair : 'anon';
      const dot = document.createElement('span'); dot.textContent = 'Â·';
      const t = document.createElement('span'); t.textContent = new Date(row.created_at).toLocaleString();
      head.append(f, dot, t);
      const body = document.createElement('div');
      body.className = 'rcontent'; body.textContent = row.content;
      el.append(head, body);
      return el;
    }

    function renderPost(row){
      const isMat = rowIsMaturePost(row);
      TL.POST_MATURE.set(row.id, isMat);

      if (!shouldRenderPost(row)) return null;
      if (TL.seen.has(row.id)) return null;
      TL.seen.add(row.id);

      const el = document.createElement('div');
      el.className = 'post';
      el.dataset.id = row.id;

      const head = document.createElement('div');
      head.className = 'headerline';
      const flair = document.createElement('span');
      flair.className = 'flair';
      flair.textContent = (TL.HAS_FLAIR && row.flair) ? row.flair : 'anon';
      const dot = document.createElement('span'); dot.textContent = 'Â·';
      const time = document.createElement('span'); time.className = 'time';
      time.textContent = new Date(row.created_at).toLocaleString();
      head.append(flair, dot, time);

      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = row.content;

      const actions = emojiRow(row);
      const rsec = repliesSection(row);

      el.append(head, content, actions, rsec);
      return el;
    }

    function appendRows(rows, {prepend=false} = {}){
      if (!rows.length) return;
      const frag = document.createDocumentFragment();
      for (const r of rows){
        TL.POST_MATURE.set(r.id, rowIsMaturePost(r)); // store even if not rendering due to toggle
        const node = renderPost(r);
        if (node) frag.appendChild(node);
      }
      if (prepend) TL.els.feed.prepend(frag); else TL.els.feed.appendChild(frag);
    }

    function groupBy(arr, key) {
      const m = new Map();
      for (const item of arr) {
        const k = item[key];
        if (!m.has(k)) m.set(k, []);
        m.get(k).push(item);
      }
      return m;
    }

    function renderRepliesBatch(groups) {
      for (const [post_id, rows] of groups.entries()) {
        const wrap = document.getElementById(`replies_${post_id}`);
        if (!wrap) continue;
        [...wrap.querySelectorAll('.reply')].forEach(n => n.remove());

        const parentMat = TL.visibility.parentIsMature(post_id);
        for (const r of rows) {
          if (TL.SHOW_MATURE || (!parentMat && !TL.visibility.rowIsMatureReply(r))) {
            wrap.insertBefore(renderReply(r), wrap.lastChild);
          }
        }
      }
    }

    return { emojiRow, renderReply, renderPost, appendRows, groupBy, renderRepliesBatch };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE G] DATA (Supabase queries)
   * ============================================================ */
  TL.data = (function(){
    async function hydrateReactions(postIds){
      const visible = postIds.filter(Boolean);
      if (!TL.REACTIONS_AVAILABLE || !visible.length) return;
      const { data, error, status } = await TL.sb.from('reactions')
        .select('post_id, emoji').in('post_id', visible);

      if (status === 404 || (error && /reactions.*not.*found/i.test(error.message||''))){
        TL.REACTIONS_AVAILABLE = false;
        document.querySelectorAll('.actions').forEach(a => a.style.display = 'none');
        return;
      }
      if (error){ console.warn('reactions fetch error', error); return; }

      const agg = {};
      for (const r of (data||[])){ const k = `${r.post_id}:${r.emoji}`; agg[k] = (agg[k]||0)+1; }
      for (const pid of visible){
        ['up','down','like','lol','heart'].forEach(em=>{
          const el = document.getElementById(`c_${pid}_${em}`);
          if (el) el.textContent = agg[`${pid}:${em}`] || 0;
        });
      }
    }

    async function react(post_id, emoji, btn){
      if (!TL.REACTIONS_AVAILABLE) return;
      btn.disabled = true;
      try{
        const { error, status } = await TL.sb.from('reactions').insert({ post_id, session_tag: TL.session.tag, emoji });
        if (status === 404 || (error && /reactions.*not.*found/i.test(error.message||''))){
          TL.REACTIONS_AVAILABLE = false;
          document.querySelectorAll('.actions').forEach(a => a.style.display = 'none');
          return;
        }
        if (error){ console.warn('reaction error', error.message || error.code); }
        else{
          const c = document.getElementById(`c_${post_id}_${emoji}`);
          if (c) c.textContent = String((parseInt(c.textContent||'0',10))+1);
        }
      } finally { btn.disabled = false; }
    }

    async function report(post_id){
      if (!confirm('Report this post for moderation?')) return;
      const ins = await TL.sb.from('reports').insert({ post_id, session_tag: TL.session.tag });
      if (ins.error){
        alert('Already reported or failed.');
        console.warn('report error', ins.error);
        return;
      }
      const cnt = await TL.sb.from('reports')
        .select('post_id', { count: 'exact', head: true })
        .eq('post_id', post_id);
      const total = cnt.count ?? 0;
      if (total >= 3){
        const node = document.querySelector(`.post[data-id="${post_id}"]`);
        if (node) node.remove();
        TL.util.toast('Post hidden by community');
      } else {
        TL.util.toast('Reported');
      }
    }

    async function insertPost(payload){
      if (TL.HAS_FLAIR || TL.HAS_MATURE_POSTS){
        const r1 = await TL.sb.from('posts').insert(payload);
        if (!r1.error) return r1;
        if (r1.error){
          if (TL.HAS_FLAIR && (r1.error.code === '42703' || /flair.*does not exist/i.test(r1.error.message||''))) TL.HAS_FLAIR = false;
          if (TL.HAS_MATURE_POSTS && (r1.error.code === '42703' || /mature.*does not exist/i.test(r1.error.message||''))) TL.HAS_MATURE_POSTS = false;
          if (TL.HAS_FLAIR || TL.HAS_MATURE_POSTS) return insertPost({ content: payload.content });
          return r1;
        }
      }
      return TL.sb.from('posts').insert({ content: payload.content });
    }

    async function fetchPage(cursor){
      const baseFields = 'id, content, created_at'
        + (TL.HAS_FLAIR ? ', flair' : '')
        + (TL.HAS_MATURE_POSTS ? ', mature' : '');

      let q = TL.sb.from(TL.SOURCE)
        .select(baseFields)
        .order('created_at', { ascending:false })
        .order('id', { ascending:false })
        .limit(TL.PAGE_SIZE);

      if (!TL.SHOW_MATURE && TL.HAS_MATURE_POSTS) q = q.eq('mature', false);

      if (cursor){
        // IMPORTANT: use raw ISO, not URL-encoded (fixes invalid timestamp bug)
        const cts = cursor.created_at;
        const cid = cursor.id;
        q = q.or(`created_at.lt.${cts},and(created_at.eq.${cts},id.lt.${cid})`);
      }

      const { data, error, status } = await q;

      if ((status === 404 && TL.SOURCE === 'posts_public') ||
          (error && ((error.code === '42P01') || /posts_public/i.test(error.message||'')))){
        TL.SOURCE = 'posts'; TL.util.showStatus('fallback'); return fetchPage(cursor);
      }

      if (status === 400 || (error && (error.code === '42703'))){
        if (/flair.*does not exist/i.test(error?.message||'')) { if (TL.HAS_FLAIR){ TL.HAS_FLAIR = false; return fetchPage(cursor);} }
        if (/mature.*does not exist/i.test(error?.message||'')) { if (TL.HAS_MATURE_POSTS){ TL.HAS_MATURE_POSTS = false; return fetchPage(cursor);} }
      }

      if (error){
        console.error('SELECT error:', error);
        TL.util.showStatus(error.message || 'load error');
        return { rows:[], hasMore:false, newCursor:null };
      }

      const rows = (data || []).filter(r => TL.visibility.shouldRenderPost(r));
      const last = (data || [])[ (data||[]).length - 1 ] || null;
      const hasMore = (data||[]).length === TL.PAGE_SIZE;
      return { rows, hasMore, newCursor: last ? { created_at: last.created_at, id: last.id } : null };
    }

    async function loadRepliesForPosts(postIds){
      if (!postIds.length) return;
      let q = TL.sb.from('replies')
        .select(TL.HAS_MATURE_REPLIES ? 'id, post_id, content, created_at, flair, mature' : 'id, post_id, content, created_at, flair')
        .in('post_id', postIds)
        .order('post_id', { ascending: true })
        .order('created_at', { ascending: true });

      if (TL.HAS_MATURE_REPLIES && !TL.SHOW_MATURE) q = q.eq('mature', false);

      const { data, error, status } = await q;

      if (status === 400 || (error && (error.code === '42703' || /mature.*does not exist/i.test(error.message||'')))) {
        if (TL.HAS_MATURE_REPLIES){ TL.HAS_MATURE_REPLIES = false; return loadRepliesForPosts(postIds); }
      }
      if (error) { console.warn('replies bulk load error', error); return; }

      const grouped = TL.render.groupBy(data || [], 'post_id');
      TL.render.renderRepliesBatch(grouped);
    }

    async function loadReplies(post_id){
      let q = TL.sb.from('replies')
        .select(TL.HAS_MATURE_REPLIES ? 'id, post_id, content, created_at, flair, mature' : 'id, post_id, content, created_at, flair')
        .eq('post_id', post_id)
        .order('created_at', { ascending: true })
        .limit(200);

      if (TL.HAS_MATURE_REPLIES && !TL.SHOW_MATURE) q = q.eq('mature', false);

      const { data, error, status } = await q;

      if (status === 400 || (error && (error.code === '42703' || /mature.*does not exist/i.test(error.message||'')))) {
        if (TL.HAS_MATURE_REPLIES){ TL.HAS_MATURE_REPLIES = false; return loadReplies(post_id); }
      }
      if (error){ console.warn('replies load error', error); return; }

      const m = new Map([[post_id, data || []]]);
      TL.render.renderRepliesBatch(m);
    }

    return { hydrateReactions, react, report, insertPost, fetchPage, loadRepliesForPosts, loadReplies };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE H] ACTIONS (posting, pagination, reload, replies)
   * ============================================================ */
  TL.actions = (function(){
    const { els, sanitize, getCooldownLeft, setJustPosted } = TL.util;

    async function initialLoad(){
      const { rows, hasMore, newCursor } = await TL.data.fetchPage(null);
      els.feed.innerHTML = '';
      TL.render.appendRows(rows);
      await TL.data.hydrateReactions(rows.map(r=>r.id));
      await TL.data.loadRepliesForPosts(rows.map(r => r.id));
      TL.nextCursor = newCursor;
      updatePager(hasMore);
    }

    function updatePager(hasMore){
      els.loadMoreBtn.disabled = !hasMore;
      els.moreLabel.textContent = hasMore ? 'Load more' : 'No more posts';
    }
    function setLoading(v){
      els.loadMoreBtn.disabled = v;
      els.moreSpin.style.display = v ? 'inline-block' : 'none';
      els.moreLabel.textContent = v ? 'Loadingâ¦' : 'Load more';
    }

    async function loadMore(){
      if (els.loadMoreBtn.disabled) return;
      setLoading(true);
      const { rows, hasMore, newCursor } = await TL.data.fetchPage(TL.nextCursor);
      TL.render.appendRows(rows);
      await TL.data.hydrateReactions(rows.map(r=>r.id));
      await TL.data.loadRepliesForPosts(rows.map(r => r.id));
      TL.nextCursor = newCursor;
      updatePager(hasMore);
      setLoading(false);
    }

    async function reloadFeed(){
      TL.seen.clear();
      TL.nextCursor = null;
      TL.POST_MATURE.clear();
      els.feed.innerHTML = '';
      await initialLoad();
    }

    async function sendReply(post_id, textarea){
      const content = sanitize(textarea.value);
      if (!content) return;
      if (TL.safety.needsNudge(content)){
        const ok = confirm('This reply may be uncivil or mature. Are you sure you want to post it?');
        if (!ok) return;
      }
      textarea.disabled = true;
      try{
        let payload = { post_id, content, flair: TL.session.tag };
        if (TL.HAS_MATURE_REPLIES) payload.mature = TL.safety.isMatureText(content);
        const r = await TL.sb.from('replies').insert(payload);
        if (r.error){
          if (r.error.code === '42703' || /mature.*does not exist/i.test(r.error.message||'')) {
            TL.HAS_MATURE_REPLIES = false;
            await TL.sb.from('replies').insert({ post_id, content, flair: TL.session.tag });
          } else {
            throw r.error;
          }
        }
        textarea.value = '';
        TL.data.loadReplies(post_id);
      }catch(e){
        alert('Reply failed: ' + (e?.message || 'see console'));
        console.error(e);
      }finally{
        textarea.disabled = false;
      }
    }

    async function post(){
      const left = getCooldownLeft();
      if (left>0){ TL.els.cool.textContent = left; return; }
      const content = TL.util.sanitize(TL.els.text.value);
      if (!content) return;

      if (TL.safety.needsNudge(content)){
        const ok = confirm('This post may be uncivil or mature. Are you sure you want to post it?');
        if (!ok) return;
      }

      TL.els.postBtn.disabled = true;
      try{
        let payload = { content, flair: TL.session.tag };
        if (TL.HAS_MATURE_POSTS) payload.mature = TL.safety.isMatureText(content);
        const { error } = await TL.data.insertPost(payload);
        if (error) throw error;
        TL.els.text.value = '';
        TL.els.count.textContent = '0';
        setJustPosted();
        TL.util.toast('Posted!');
      }catch(e){
        alert('Post failed: ' + (e?.message || 'see console'));
        console.error(e);
        TL.util.showStatus(e?.message || 'insert error');
      }finally{ TL.els.postBtn.disabled = false; }
    }

    return { initialLoad, loadMore, reloadFeed, sendReply, post, updatePager };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE I] SUBSCRIPTIONS (realtime)
   * ============================================================ */
  TL.live = (function(){
    function subscribe(){
      TL.sb.channel('threadless_posts')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'posts' }, payload=>{
          const row = payload.new;
          TL.POST_MATURE.set(row.id, TL.visibility.rowIsMaturePost(row));
          if (!TL.visibility.shouldRenderPost(row)) return;
          const node = TL.render.renderPost(row);
          if (node) { TL.els.feed.prepend(node); TL.data.hydrateReactions([row.id]); }
        })
        .on('postgres_changes', { event:'DELETE', schema:'public', table:'posts' }, payload=>{
          const el = document.querySelector(`.post[data-id="${payload.old.id}"]`);
          if (el) el.remove();
          TL.POST_MATURE.delete(payload.old.id);
        })
        .subscribe((state)=>{ TL.util.showStatus(state === 'SUBSCRIBED' ? 'online' : state.toLowerCase()); });

      TL.sb.channel('threadless_reports')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'reports' }, async payload=>{
          const pid = payload.new.post_id;
          const check = await TL.sb.from(TL.SOURCE).select('id').eq('id', pid).maybeSingle();
          if (!check.data){
            const el = document.querySelector(`.post[data-id="${pid}"]`);
            if (el) el.remove();
            TL.POST_MATURE.delete(pid);
          }
        })
        .subscribe();

      if (TL.REACTIONS_AVAILABLE){
        TL.sb.channel('threadless_reacts')
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'reactions' }, payload=>{
            const { post_id, emoji } = payload.new;
            const c = document.getElementById(`c_${post_id}_${emoji}`);
            if (c) c.textContent = String((parseInt(c.textContent||'0',10))+1);
          })
          .subscribe();
      }

      TL.sb.channel('threadless_replies')
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'replies' }, payload=>{
          const r = payload.new;
          if (TL.visibility.shouldRenderReply(r)){
            const wrap = document.getElementById(`replies_${r.post_id}`);
            if (wrap){
              const node = TL.render.renderReply(r);
              wrap.insertBefore(node, wrap.lastChild);
            }
          }
        })
        .subscribe();
    }
    return { subscribe };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE J] PROMPTS
   * ============================================================ */
  TL.prompts = (function(){
    const PROMPTS = [
      "Whatâs a tiny habit that changed your life?",
      "Describe a place you miss that no longer exists.",
      "Whatâs something you believed as a kid thatâs still kind of true?",
      "Teach us a one-minute skill.",
      "Whatâs the best question to ask a stranger?",
      "Share an unpopular opinion you can defend politely.",
      "Whatâs the most useful thing you learned this month?",
      "Describe your ideal 15-minute break?",
      "Whatâs a problem you solved in a weird way?",
      "Whatâs a small joy from today?"
    ];
    function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

    async function ensurePromptOfDay(){
      const key = localStorage.getItem('threadless_prompt_date');
      const today = todayKey();
      if (key === today) return;

      const start = new Date(); start.setHours(0,0,0,0);
      const end = new Date(); end.setHours(23,59,59,999);

      const { data, error } = await TL.sb.from(TL.SOURCE)
        .select('id').gte('created_at', start.toISOString()).lte('created_at', end.toISOString())
        .eq('flair','PromptBot').limit(1);
      if (!error && data && data.length) { localStorage.setItem('threadless_prompt_date', today); return; }

      const prompt = PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
      await TL.data.insertPost({ content: `Prompt of the day: ${prompt}`, flair: 'PromptBot' });
      localStorage.setItem('threadless_prompt_date', today);
    }

    return { ensurePromptOfDay };
  })();
  </script>

  <script>
  /* ============================================================
   * [MODULE K] BOOT / WIRING
   * ============================================================ */
  (async function boot(){
    // Supabase
    TL.sb = supabase.createClient(TL.SUPABASE_URL, TL.SUPABASE_ANON_KEY);

    // Wire UI
    const { els } = TL.util;
    els.matureToggle.checked = TL.SHOW_MATURE;
    els.matureToggle.addEventListener('change', ()=>{
      TL.setShowMature(els.matureToggle.checked);
    });
    TL.util.$('rerollBtn').addEventListener('click', TL.session.rerollTag);

    // Composer
    els.text.addEventListener('input', ()=>{ els.count.textContent = els.text.value.length; });
    els.text.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); TL.actions.post(); }});
    els.postBtn.addEventListener('click', TL.actions.post);

    // Pager + scroll
    els.loadMoreBtn.addEventListener('click', TL.actions.loadMore);
    let autoLoading = false;
    window.addEventListener('scroll', async ()=>{
      if (autoLoading || els.loadMoreBtn.disabled) return;
      const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
      if (nearBottom){ autoLoading = true; await TL.actions.loadMore(); autoLoading = false; }
    });

    // Cooldown ticker
    (async function tick(){ while(true){ els.cool.textContent = TL.util.getCooldownLeft(); await TL.util.sleep(500);} })();

    // Safety words
    TL.util.showStatus('connectingâ¦');
    await TL.safety.loadFromDB();

    // Initial load + live + prompt
    await TL.actions.initialLoad();
    TL.live.subscribe();
    await TL.prompts.ensurePromptOfDay();
  })();
  </script>

  <script>
/* ============================================================
 * [MODULE L] RESPONSIVE / MOBILE TWEAKS (drop-in)
 *  - No markup changes required
 *  - Injects a small CSS override + toggles compact UX on mobile
 * ============================================================ */
(function responsiveModule(){
  const CSS = `
  /* --- layout tweaks shared --- */
  .topbar { gap: 10px; }
  .theme-select { min-width: 120px; }
  .meta { white-space: nowrap; }
  .actions { flex-wrap: wrap; }

  /* --- MOBILE RULES --- */
  @media (max-width: 720px){
    .wrap{ padding:12px; }
    .topbar{ flex-wrap: wrap; align-items: flex-start; }
    .brand{ flex: 1 1 100%; min-width: 0; }
    .brand h1{ font-size:20px; }
    .brand .sub{ font-size:12px; }

    /* Hide the long ALPHA badge on narrow screens */
    .topbar .alpha{ display:none; }

    /* Controls cluster: theme + mature + status stack nicely */
    .topbar > div[style*="display:flex"]{
      flex: 1 1 100%;
      flex-wrap: wrap;
      gap: 8px;
    }

    .theme-switch { order: 1; font-size:12px; gap:6px; }
    .theme-select { max-width: 140px; }

    .switch { order: 2; font-size:12px; gap:6px; }

    /* Keep online pill visible; don't let it overflow to the right */
    #status.pill{
      order: 3;
      margin-left: 0 !important;
      align-self: center;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Composer row: let metadata wrap beneath the Post button */
    .row{ flex-wrap: wrap; }
    .meta{
      margin-left: 0;
      width: 100%;
      text-align: left;
      font-size: 11px;
      color: var(--muted);
    }

    /* Replies action row can wrap */
    .actions{ gap:8px; }

    /* Slightly smaller textarea min-height on phones */
    textarea{ min-height: 90px; }
  }

  /* --- VERY SMALL PHONES (<=360px) --- */
  @media (max-width: 360px){
    .theme-select { max-width: 120px; }
    .brand h1{ font-size:18px; }
  }
  `;

  // Inject style tag once
  const styleId = 'tl-responsive-overrides';
  if (!document.getElementById(styleId)){
    const s = document.createElement('style');
    s.id = styleId;
    s.textContent = CSS;
    document.head.appendChild(s);
  }

  // JS helpers to toggle compact labels on mobile
  const mq = window.matchMedia('(max-width: 720px)');
  const likelyTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Cache original label text so we can restore on desktop
  let originalMatureLabelText = null;

  function setMatureLabel(compact){
    const lbl = document.querySelector('label.switch');
    if (!lbl) return;
    // The label structure is: <label class="switch"><input .../> TEXT</label>
    // Grab the last text node or create a span for safety.
    // We'll normalize into a span with id to make swapping reliable.
    let textSpan = lbl.querySelector('#tl-mature-text');
    if (!textSpan){
      // extract trailing text
      const trailingText = Array.from(lbl.childNodes)
        .filter(n => n.nodeType === Node.TEXT_NODE)
        .map(n => n.nodeValue).join(' ').trim() || 'Show mature';
      // remember original once
      if (originalMatureLabelText === null) originalMatureLabelText = trailingText;
      // clear old text nodes
      Array.from(lbl.childNodes).forEach(n=>{
        if (n.nodeType === Node.TEXT_NODE) lbl.removeChild(n);
      });
      // attach span
      textSpan = document.createElement('span');
      textSpan.id = 'tl-mature-text';
      textSpan.style.marginLeft = '2px';
      textSpan.textContent = trailingText;
      lbl.appendChild(textSpan);
    } else {
      if (originalMatureLabelText === null) originalMatureLabelText = textSpan.textContent || 'Show mature';
    }
    textSpan.textContent = compact ? 'Mature' : originalMatureLabelText || 'Show mature';
    lbl.title = 'Toggle mature/explicit content';
  }

  function applyCompactUI(){
    const isMobile = mq.matches || likelyTouch;
    document.documentElement.classList.toggle('is-mobile', !!isMobile);
    setMatureLabel(!!isMobile);

    // Keep the status pill text concise on phones
    const st = document.getElementById('status');
    if (st){
      // normalize known values to short variants
      const t = (st.textContent || '').toLowerCase().trim();
      if (isMobile){
        if (t.includes('connecting')) st.textContent = 'connectingâ¦';
        else if (t.includes('subscribed') || t.includes('online')) st.textContent = 'online';
        else if (t.includes('closed')) st.textContent = 'offline';
      } else {
        // leave whatever TL.live sets; don't force long text
      }
    }
  }

  // Run now and on changes
  applyCompactUI();
  mq.addEventListener ? mq.addEventListener('change', applyCompactUI)
                      : mq.addListener(applyCompactUI);
  window.addEventListener('orientationchange', applyCompactUI);
  window.addEventListener('resize', debounce(applyCompactUI, 150));

  // Lightweight debounce
  function debounce(fn, ms){
    let t; return function(){ clearTimeout(t); t = setTimeout(fn, ms); };
  }
})();
</script>
</body>
</html>



