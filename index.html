<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AnonBoard</title>
  <style>
    :root { --bg:#0b0f14; --card:#121923; --muted:#8aa0b8; --ink:#e8eef6; --accent:#4aa8ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,Segoe UI,Inter,Arial}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f1488,#0b0f1400);backdrop-filter:blur(6px);border-bottom:1px solid #1d2733}
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px 0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    .composer{margin:16px 0;padding:12px;background:var(--card);border:1px solid #1d2733;border-radius:16px;box-shadow:0 10px 30px #0003}
    textarea{width:100%;min-height:96px;background:#0e141c;color:var(--ink);border:1px solid #243244;border-radius:12px;padding:12px;resize:vertical;outline:none}
    .row{display:flex;gap:12px;align-items:center;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#031222;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .meta{margin-left:auto;color:var(--muted);font-size:12px}
    .feed{display:flex;flex-direction:column;gap:12px;margin:20px 0}
    .post{padding:14px 14px 10px;background:var(--card);border:1px solid #1d2733;border-radius:16px}
    .content{white-space:pre-wrap;word-wrap:break-word}
    .time{margin-top:8px;color:var(--muted);font-size:12px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .pill{font-size:12px;color:var(--muted)}
    .notice{margin-top:8px;color:#ffca6b;font-size:12px}
    .footer{margin:36px 0;color:var(--muted);font-size:12px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div>
          <h1>AnonBoard</h1>
          <div class="sub">A single, continuously updating text board. No accounts, no likes—just posts.</div>
        </div>
        <div class="pill" id="status">connecting…</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="composer">
      <textarea id="text" maxlength="1000" placeholder="Share a thought… (Enter to post, Shift+Enter for newline)"></textarea>
      <div class="row">
        <button class="btn" id="postBtn">Post</button>
        <div class="meta"><span id="count">0</span>/1000 • cooldown: <span id="cool">0</span>s</div>
      </div>
      <div class="notice">Be civil. Don’t post illegal or harmful content. This is public.</div>
    </section>

    <section class="feed" id="feed"></section>

    <div class="footer">
      <strong>Tips</strong>: Shift+Enter inserts a newline. Page live-updates. Content is immutable.<br/>
      Roadmap: per-board filters, images, moderation panel, server-side rate limits.
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // 1) Initialize Firebase
    const firebaseConfig = {
      // TODO: paste your Firebase config here:
      // apiKey: "…",
      // authDomain: "…",
      // projectId: "…",
      // storageBucket: "…",
      // messagingSenderId: "…",
      // appId: "…"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // 2) State/Elems
    const feedEl   = document.getElementById('feed');
    const textEl   = document.getElementById('text');
    const postBtn  = document.getElementById('postBtn');
    const countEl  = document.getElementById('count');
    const coolEl   = document.getElementById('cool');
    const statusEl = document.getElementById('status');

    const MAXLEN = 1000;
    const COOLDOWN_SEC = 15; // simple client cooldown per session

    // 3) Helpers
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    function nowSec(){ return Math.floor(Date.now()/1000); }
    function getCooldownLeft(){
      const last = Number(localStorage.getItem('lastPostTs') || '0');
      const left = Math.max(0, (last + COOLDOWN_SEC) - nowSec());
      return left;
    }
    function setJustPosted(){ localStorage.setItem('lastPostTs', String(nowSec())); }
    function sanitize(s){
      // very basic trim; let Firestore rules enforce length
      return s.replace(/\s+$/,'').replace(/^\s+/, '');
    }
    function fmtTime(ts){
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString();
    }

    // 4) Auth anonymously
    async function ensureAnonAuth(){
      try{
        const user = await new Promise((resolve,reject)=>{
          const unsub = auth.onAuthStateChanged(u=>{
            unsub();
            if(u) resolve(u);
            else auth.signInAnonymously().then(({user})=>resolve(user)).catch(reject);
          })
        });
        statusEl.textContent = 'online';
        return user;
      }catch(e){
        console.error(e);
        statusEl.textContent = 'auth error';
      }
    }

    // 5) Live feed (newest first)
    function renderPost(doc){
      const d = doc.data();
      const li = document.createElement('div');
      li.className = 'post';
      li.innerHTML = `
        <div class="content"></div>
        <div class="time">#${doc.id.slice(0,6)} • ${fmtTime(d.createdAt)} • anon</div>
      `;
      li.querySelector('.content').textContent = d.content;
      return li;
    }

    function startFeed(){
      const q = db.collection('posts').orderBy('createdAt','desc').limit(100);
      q.onSnapshot(snap=>{
        // re-render simple (for 100 items it’s fine)
        feedEl.innerHTML = '';
        snap.docs.forEach(doc=>{
          feedEl.appendChild(renderPost(doc));
        });
      }, err=>{
        console.error(err);
        statusEl.textContent = 'stream error';
      });
    }

    // 6) Composer interactions
    textEl.addEventListener('input', ()=>{
      countEl.textContent = textEl.value.length;
    });

    textEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        postBtn.click();
      }
    });

    async function post(){
      const left = getCooldownLeft();
      if(left>0){
        coolEl.textContent = left;
        return;
      }
      const content = sanitize(textEl.value);
      if(!content){ return; }
      postBtn.disabled = true;

      try{
        const uid = auth.currentUser?.uid || null;
        await db.collection('posts').add({
          content,
          uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        textEl.value=''; countEl.textContent='0';
        setJustPosted();
      }catch(e){
        alert('Post failed. Try again.');
        console.error(e);
      }finally{
        postBtn.disabled = false;
      }
    }
    postBtn.addEventListener('click', post);

    // 7) Cooldown ticker
    (async function tick(){
      while(true){
        coolEl.textContent = getCooldownLeft();
        await sleep(500);
      }
    })();

    // 8) Boot
    (async function main(){
      await ensureAnonAuth();
      startFeed();
    })();
  </script>
</body>
</html>
